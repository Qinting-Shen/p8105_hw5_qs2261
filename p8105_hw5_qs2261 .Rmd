---
title: "p8105_hw5_qs2261"
author: "Qinting Shen"
date: "2023-11-10"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rvest)
library(purrr)
```

### Peoblem 2
#### Import Data

```{r, message = FALSE}
filename = list.files("data", full.names = TRUE) # create a df containing all file names

importdata = function(path) {
  
  df = read_csv(path) |> 
    janitor::clean_names() |> 
    mutate(file = path)
}

longi_df = map(filename, importdata) |> 
  bind_rows()
```

#### Data Wrangling and Plotting
```{r}
tidy_plot =
  longi_df |> 
  separate(file, into = c("folder","arm","underscore","subject_id","csv"), sep = c(5,8,9,11)) |> 
  mutate(arm_id = paste(arm, subject_id)) |> 
  select(-folder, -underscore, - csv) |> 
  select(arm, subject_id, everything()) |> 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "observation" )|> 
  ggplot(aes(x = week, y = observation, group = arm_id, color = arm))+
    geom_line()

tidy_plot
```

The spaghetti plot shows that the observations on each subject in control group fluctuates but remain stable, while those in experimental group are increasing over time. And compared to control group, the mean values of observations of each subject are higher in experimental group.


### Peoblem 3
#### Create a function
```{r}
set.seed(1)
one_samp = function(n= 30, mu, sigma = 5){
  
  sim_data = tibble(
    x = rnorm(n = n, mean = mu, sd = sigma),
  )
  broom::tidy(t.test(sim_data, mu = mu)) 
}
```

#### mu = 0, repeat 5000 times
```{r}
ttest_results_df =
  rerun(5000, one_samp(mu = 0)) |> 
  bind_rows() |> 
  select(estimate, p.value)
```

#### Repeat for mu = 1,2,3,4,5,6
```{r warning=FALSE}
mu_list = 
  list(
    "mu = 1" = 1,
    "mu = 2" = 2,
    "mu = 3" = 3,
    "mu = 4" = 4,
    "mu = 5" = 5,
    "mu = 6" = 6
  )

output = vector("list", length = 6)

for (i in 1:6) {
  output[[i]] = rerun(5000, one_samp(mu = mu_list[[i]])) |> 
    bind_rows() |> 
    select(estimate, p.value)
  
}
```

```{r}
ttest_result = 
  expand_grid(
    true_mean = c(1, 2, 3, 4, 5, 6),
    iter = 1:5000
) |> 
  mutate(
    estimate_df = map(true_mean, one_samp))|> 
  unnest(estimate_df) |> 
  select(true_mean, estimate, p.value)
```
????why
```{r}
ttest_result = 
 tibble(true_mean = c(1, 2, 3, 4, 5, 6)
        ) |> 
  mutate(
    estimate_df = map(.x = true_mean, ~ rerun(10, one_samp(.x))))|> 
  unnest(estimate_df) |> 
  select(true_mean, estimate, p.value)
```


#### Plot
```{r}
results_df = 
output
  mutate(
    estimate_df = 
      map2(sample_size, population_mean, \(n, population_mean) t_test_multiple_means(n = 30, sigma = 5, population_mean))
  ) |>
  unnest(estimate_df) |> 
  unnest(estimate_df) 
```

#### Plot

```{r}
power_plot_df = 
  results_df |>
  select(population_mean, estimate, p.value) |>
  group_by(population_mean) |>
  summarize(n_obs = n()) |>
  mutate(props = round(n_obs / sum(n_obs), 2)) |>
  ggplot(aes(x = population_mean, y = props)) +
  geom_point() +
  labs(
    title = "Effect size and power",
    x = "True value of Î¼",
    y = "Power of test"
  )

power_plot_df
```



